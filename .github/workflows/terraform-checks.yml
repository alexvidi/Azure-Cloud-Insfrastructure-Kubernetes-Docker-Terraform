# -----------------------------------------------------------------------------
# GitHub Actions Workflow: Infrastructure & Manifest Validation
#
# Goal:
# - Execute Terraform quality gates (fmt + validate) for IaC stability.
# - Perform schema validation on Kubernetes manifests using Kubeconform.
# - Lint Helm charts and validate the rendered templates against K8s schemas.
#
# When it runs:
# - Manual trigger (workflow_dispatch).
# - On Pull Requests touching infrastructure, K8s, or Helm paths.
# - On pushes to master affecting the same scopes.
# -----------------------------------------------------------------------------

name: Quality Gates

# -----------------------------------------------------------------------------
# TRIGGERS
# -----------------------------------------------------------------------------
on:
  workflow_dispatch:  

  pull_request:
    paths:
      - "infra/**"
      - "k8s/**"
      - "helm/**"
  
  push:
    branches: ["master"]
    paths:
      - "infra/**"
      - "k8s/**"
      - "helm/**"

jobs:
  # -----------------------------------------------------------------------------
  # JOB 1: TERRAFORM VALIDATION
  # -----------------------------------------------------------------------------
  terraform:
    name: Terraform Static Analysis
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infra
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
      
      - name: Terraform Init & Validate
        run: |
          terraform init -backend=false
          terraform validate

  # -----------------------------------------------------------------------------
  # JOB 2: KUBERNETES & HELM QUALITY GATES
  # -----------------------------------------------------------------------------
  kubernetes-validation:
    name: K8s & Helm Schema Validation
    runs-on: ubuntu-latest
    env:
      KUBECONFORM_VERSION: "v0.6.4" # Centralized version for easier updates
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Helm CLI
        uses: azure/setup-helm@v4

      # Professional way to install binaries when no official action exists
      - name: Install Kubeconform
        run: |
          curl -sSL https://github.com/yannh/kubeconform/releases/download/${{ env.KUBECONFORM_VERSION }}/kubeconform-linux-amd64.tar.gz | tar -xz kubeconform
          sudo mv kubeconform /usr/local/bin/
          kubeconform -v

      # Validate raw manifests in /k8s folder
      - name: Validate Static Manifests
        run: |
          kubeconform -strict -summary k8s/

      # Check Helm chart consistency
      - name: Helm Lint
        run: helm lint helm/nn-predictor

      # Catch templating errors by validating the rendered output
      - name: Render & Validate Helm Templates
        run: |
          helm template nn-predictor helm/nn-predictor > rendered.yaml
          kubeconform -strict -summary rendered.yaml