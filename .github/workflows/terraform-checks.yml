# -----------------------------------------------------------------------------
# GitHub Actions Workflow: Terraform checks
#
# Goal:
# - Run basic Terraform quality gates (fmt + validate) for IaC under /infra.
# - Validate Kubernetes manifests under /k8s using kubeconform (schema checks).
# - Lint Helm chart under /helm and validate the rendered output with kubeconform.
#
# When it runs:
# - Manual trigger (workflow_dispatch)
# - On Pull Requests that touch workflow/IaC/K8s/Helm paths
# - On pushes to master that touch the same paths
# -----------------------------------------------------------------------------

name: Terraform checks

# -----------------------------------------------------------------------------
# TRIGGERS
# -----------------------------------------------------------------------------
on:
  
  workflow_dispatch:  

  # Run on PRs only when relevant files change (faster + cheaper CI).
  pull_request:
    paths:
      - ".github/workflows/**"  
      - "infra/**"
      - "k8s/**"
      - "helm/**"
  
  # Run on pushes to master, also scoped to relevant folders.    
  push:
    branches: ["master"]
    paths:
      - ".github/workflows/**"
      - "infra/**"
      - "k8s/**"
      - "helm/**"

jobs:
  # -----------------------------------------------------------------------------
  # JOB 1: TERRAFORM STATIC CHECKS (fmt + validate)
  # -----------------------------------------------------------------------------
  terraform:
    runs-on: ubuntu-latest

    # All `run:` commands in this job will execute from /infra by default.
    defaults:
      run:
        working-directory: infra
    # Fetch repository code so Terraform files are available.    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      # Install Terraform on the runner.
      # terraform_wrapper: false keeps Terraform output "cleaner" and closer to local behavior.
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      # Check formatting without modifying files.
      # -check     -> fails if formatting would change
      # -recursive -> includes nested modules/folders    
      - name: Terraform fmt (check)
        run: terraform fmt -check -recursive
      
      # Initialize Terraform *without* configuring the backend.
      # This allows validation even if remote state/backends are not accessible in CI.
      - name: Terraform init (no backend)
        run: terraform init -backend=false

      # Validate Terraform configuration syntax and internal consistency.  
      - name: Terraform validate
        run: terraform validate

  # -----------------------------------------------------------------------------
  # JOB 2: KUBERNETES MANIFEST VALIDATION (kubeconform)
  # -----------------------------------------------------------------------------      
  k8s-manifests:
    runs-on: ubuntu-latest
    steps:
      # Fetch repository code so /k8s manifests are available.
      - name: Checkout
        uses: actions/checkout@v4

      # Install kubeconform (binary release) to validate manifests against schemas.  
      - name: Install kubeconform
        run: |
          curl -sSL https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz -o kubeconform.tar.gz
          tar -xzf kubeconform.tar.gz kubeconform
          sudo mv kubeconform /usr/local/bin/kubeconform
          kubeconform -v

      # Validate specific Kubernetes YAMLs with strict schema checks.
      # -strict                 -> treat warnings as errors
      # -summary                -> concise output
      # -ignore-missing-schemas -> don't fail if a schema isn't available (common for some CRDs)
      # -kubernetes-version     -> schema selection aligned to a target K8s version    
      - name: Validate Kubernetes manifests (schema)
        run: |
          kubeconform -strict -summary -ignore-missing-schemas -kubernetes-version 1.33.0 k8s/deployment.yaml
          kubeconform -strict -summary -ignore-missing-schemas -kubernetes-version 1.33.0 k8s/service.yaml
          kubeconform -strict -summary -ignore-missing-schemas -kubernetes-version 1.33.0 k8s/hpa.yaml
  
  # -----------------------------------------------------------------------------
  # JOB 3: HELM CHART CHECKS (lint + render + kubeconform)
  # -----------------------------------------------------------------------------        
  helm-chart:
    runs-on: ubuntu-latest
    steps:
      # Fetch repository code so Helm chart is available under /helm.
      - name: Checkout
        uses: actions/checkout@v4

      # Install Helm CLI.  
      - name: Install Helm
        uses: azure/setup-helm@v4

       # Install kubeconform again in this job (each job runs on a fresh runner).    
      - name: Install kubeconform
        run: |
          curl -sSL https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz -o kubeconform.tar.gz
          tar -xzf kubeconform.tar.gz kubeconform
          sudo mv kubeconform /usr/local/bin/kubeconform
          kubeconform -v

      # Basic Helm chart linting (Chart.yaml, values, templates, etc.).    
      - name: Helm lint
        run: helm lint helm/nn-predictor

      # Render the chart to raw Kubernetes YAML and validate the result with kubeconform.
      # This catches schema issues that only appear after templating.  
      - name: Helm template + kubeconform
        run: |
          helm template nn-predictor helm/nn-predictor -n fastapi > rendered.yaml
          kubeconform -strict -summary -ignore-missing-schemas -kubernetes-version 1.33.0 rendered.yaml        